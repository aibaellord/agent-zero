<!DOCTYPE html>
<html lang="en" data-theme="bael-dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Bael - Lord Of All</title>
    <link rel="icon" type="image/svg+xml" href="public/bael-favicon.svg">
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="css/messages.css">
    <link rel="stylesheet" href="components/messages/action-buttons/simple-action-buttons.css">
    <link rel="stylesheet" href="css/toast.css">
    <link rel="stylesheet" href="css/settings.css">
    <link rel="stylesheet" href="css/modals.css">
    <link rel="stylesheet" href="css/speech.css">
    <link rel="stylesheet" href="css/scheduler-datepicker.css">
    <link rel="stylesheet" href="css/notification.css">
    <link rel="stylesheet" href="css/buttons.css">

    <!-- BAEL Theme System -->
    <link rel="stylesheet" href="css/bael-themes.css">

    <!-- BAEL Core System - Load Early -->
    <script src="js/bael-core.js"></script>

    <!-- Flatpickr for datetime picker -->
    <link rel="stylesheet" href="vendor/flatpickr/flatpickr.min.css">
    <script src="vendor/flatpickr/flatpickr.min.js"></script>

    <script>
        globalThis.safeCall = function (name, ...args) {
            if (window[name]) window[name](...args)
        }
    </script>

    <!-- Pre-initialize schedulerSettings to ensure Alpine doesn't miss it -->
    <script>
        // Pre-define schedulerSettings skeleton to ensure it's available to Alpine
        globalThis.schedulerSettings = function () {
            return {
                tasks: [],
                isLoading: true,
                selectedTask: null,
                expandedTaskId: null,
                sortField: 'name',
                sortDirection: 'asc',
                filterType: 'all',
                filterState: 'all',
                pollingInterval: null,
                pollingActive: false,
                editingTask: {
                    name: '',
                    type: 'scheduled',
                    state: 'idle',
                    schedule: {
                        minute: '*',
                        hour: '*',
                        day: '*',
                        month: '*',
                        weekday: '*',
                        timezone: ''
                    },
                    token: '',
                    plan: {
                        todo: [],
                        in_progress: null,
                        done: []
                    },
                    system_prompt: '',
                    prompt: '',
                    attachments: []
                },
                isCreating: false,
                isEditing: false,
                showLoadingState: false,
                viewMode: 'list',
                selectedTaskForDetail: null,
                attachmentsText: '',
                filteredTasks: [],
                // Minimal init to avoid errors
                init() {
                    console.log('Basic schedulerSettings initialized');
                    // Watch for task type changes
                    this.$watch('editingTask.type', (newType) => {
                        if (newType === 'planned') {
                            // When switching to planned task type, initialize the datetime picker
                            this.$nextTick(() => {
                                if (this.initFlatpickr) {
                                    if (this.isCreating) {
                                        this.initFlatpickr('create');
                                    } else if (this.isEditing) {
                                        this.initFlatpickr('edit');
                                    }
                                }
                            });
                        }
                    });
                }
            };
        };
    </script>

    <!-- Load module scripts first -->
    <script type="module" src="js/scheduler.js"></script>

    <script type="module" src="index.js"></script>

    <!-- Bootstrap JS (only for logic, importing bundled CSS => UI conflicts) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <!-- Then load Alpine.js -->
    <!-- <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js"></script> -->
    <script type="module" src="js/initFw.js"></script>

    <script src="vendor/ace-min/ace.js"></script>
    <link href="vendor/ace-min/ace.min.css" rel="stylesheet">
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="vendor/katex/katex.min.css" crossorigin="anonymous">

    <!-- KaTeX javascript -->
    <script defer src="vendor/katex/katex.min.js" crossorigin="anonymous"></script>
    <script defer src="vendor/katex/katex.auto-render.min.js" crossorigin="anonymous"></script>

    <!-- QR Code Library -->
    <script src="vendor/qrcode.min.js"></script>

    <!-- Google Icons -->
    <link rel="stylesheet" href="vendor/google/google-icons.css" />

    <!-- Link the PWA manifest file -->
    <link rel="manifest" href="js/manifest.json">

    <!-- Non-module scripts after Alpine.js -->
    <script type="text/javascript" src="js/settings.js"></script>
    <script>
        // Expose git info for sidebar component
        globalThis.gitinfo = { version: "{{version_no}}", commit_time: "{{version_time}}" };
    </script>
</head>

<body class="dark-mode device-pointer" x-data>

    <!-- BAEL Welcome Screen -->
    <x-component path="bael-welcome.html"></x-component>

    <div class="container">
        <!-- Sidebar Overlay -->
        <div id="sidebar-overlay" x-data>
            <template x-if="$store.sidebar">
                <div class="sidebar-overlay" :class="{'visible': $store.sidebar.isOpen && $store.sidebar.isMobile()}" @click="$store.sidebar.close()"></div>
            </template>
        </div>
        </template>
        <!-- Left Sidebar (Header Icons, Quick Actions, Tabs, Chats, Tasks) -->
        <x-component path="sidebar/left-sidebar.html"></x-component>

        <!-- Right Panel (Message History and Input Section) -->
        <div id="right-panel" class="panel" >

            <!-- top section with time, status etc. -->
            <x-component path="chat/top-section/chat-top.html"></x-component>

            <!-- Welcome Screen Component -->
            <div x-data x-show="$store.welcomeStore && $store.welcomeStore.isVisible">
                <x-component path="welcome/welcome-screen.html"></x-component>
            </div>
            <!-- Message History (actual messages) -->
            <div id="chat-history" x-data x-show="!$store.welcomeStore || !$store.welcomeStore.isVisible"></div>

            <!-- NEW: Toast Stack Component -->
            <div style="position: relative; height: 0;">
                <x-component path="notifications/notification-toast-stack.html"></x-component>
            </div>

            <div id="toast" class="toast">
                <div class="toast__content">
                    <div class="toast__title"></div>
                    <div class="toast__separator"></div>
                    <div class="toast__message"></div>
                </div>
                <button class="toast__copy" style="display: none;">Copy</button>
                <button class="toast__close">Close</button>
            </div>
            <!-- Chat Input Area -->
            <div x-show="!$store.welcomeStore || !$store.welcomeStore.isVisible">
                <!-- Progress Bar -->
                <x-component path="chat/input/progress.html"></x-component>
                <!-- Input Section -->
                <x-component path="chat/input/chat-bar.html"></x-component>
            </div>
        </div>
    </div>
    <div id="settingsModal" x-data="settingsModalProxy">
        <template x-teleport="body">
            <div x-show="isOpen" class="modal-overlay" @click.self="handleCancel()"
                @keydown.escape.window="isOpen && handleCancel()" x-transition>
                <div class="modal-container">
                    <div class="modal-header">
                        <h2 x-text="settings.title"></h2>
                        <button class="modal-close" @click="handleCancel()">&times;</button>
                    </div>

                    <div class="modal-content">
                        <!-- Tab Navigation -->
                        <div class="settings-tabs-container">
                            <div class="settings-tabs">
                                <div class="settings-tab" :class="{'active': activeTab === 'agent'}"
                                    @click="switchTab('agent')" title="Agent Settings">Agent Settings</div>
                                <div class="settings-tab" :class="{'active': activeTab === 'external'}"
                                    @click="switchTab('external')" title="External Services">External Services</div>
                                <div class="settings-tab" :class="{'active': activeTab === 'mcp'}"
                                    @click="switchTab('mcp')" title="MCP">MCP/A2A</div>
                                <div class="settings-tab" :class="{'active': activeTab === 'developer'}"
                                    @click="switchTab('developer')" title="Developer">Developer</div>
                                <div class="settings-tab" :class="{'active': activeTab === 'scheduler'}"
                                    @click="switchTab('scheduler')" title="Task Scheduler">Task Scheduler</div>
                                <div class="settings-tab" :class="{'active': activeTab === 'heisenberg'}"
                                    @click="switchTab('heisenberg')" title="Heisenberg">Heisenberg</div>
                                <div class="settings-tab" :class="{'active': activeTab === 'backup'}"
                                    @click="switchTab('backup')" title="Backup & Restore">Backup & Restore</div>
                            </div>
                        </div>

                        <!-- Display settings sections for agent, external, developer, mcp, backup tabs -->
                        <div id="settings-sections" x-show="activeTab !== 'scheduler'">
                            <nav>
                                <ul>
                                    <template x-for="(section, index) in filteredSections" :key="section.title">
                                        <li>
                                            <a :href="'#section' + (index + 1)">
                                                <img :src="'/public/' + section.id +'.svg'" :alt="section.title">
                                                <span x-text="section.title"></span>
                                            </a>
                                        </li>
                                    </template>
                                    <!-- Tunnel navigation entry - only visible in the External Services tab -->
                                    <li x-show="activeTab === 'external'">
                                        <a href="#section-tunnel">
                                            <img src="/public/tunnel.svg" alt="Tunnel">
                                            <span>Flare Tunnel</span>
                                        </a>
                                    </li>
                                </ul>
                            </nav>

                            <template x-for="(section, sectionIndex) in filteredSections" :key="sectionIndex">
                                <div :id="'section' + (sectionIndex + 1)" class="section">
                                    <div class="section-title" x-text="section.title"></div>
                                    <div class="section-description" x-html="section.description"></div>

                                    <template x-for="(field, fieldIndex) in section.fields.filter(f => !f.hidden)"
                                        :key="fieldIndex">
                                        <div :class="{'field': true, 'field-full': field.type === 'textarea'}">
                                            <div class="field-label" x-show="field.title || field.description">
                                                <div class="field-title" x-text="field.title" x-show="field.title">
                                                </div>
                                                <div class="field-description" x-html="field.description || ''"
                                                    x-show="field.description"></div>
                                            </div>

                                            <div class="field-control">
                                                <!-- Input field -->
                                                <template x-if="field.type === 'text'">
                                                    <input type="text" :class="field.classes" :value="field.value"
                                                        :readonly="field.readonly === true"
                                                        @input="field.value = $event.target.value">
                                                </template>

                                                <!-- Number field -->
                                                <template x-if="field.type === 'number'">
                                                    <input type="number" :class="field.classes" :value="field.value"
                                                        :readonly="field.readonly === true"
                                                        @input="field.value = $event.target.value" :min="field.min"
                                                        :max="field.max" :step="field.step">
                                                </template>


                                                <!-- Password field -->
                                                <template x-if="field.type === 'password'">
                                                    <input type="password" :class="field.classes" :value="field.value"
                                                        :readonly="field.readonly === true" :id="field.id"
                                                        autocomplete="off" @input="field.value = $event.target.value">
                                                </template>

                                                <!-- Textarea field -->
                                                <template x-if="field.type === 'textarea'">
                                                    <textarea :class="field.classes" :value="field.value"
                                                        :readonly="field.readonly === true"
                                                        @input="field.value = $event.target.value"
                                                        :style="field.style"></textarea>
                                                </template>

                                                <!-- Switch field -->
                                                <template x-if="field.type === 'switch'">
                                                    <label class="toggle">
                                                        <input type="checkbox" :checked="field.value"
                                                            :disabled="field.readonly === true"
                                                            @change="field.value = $event.target.checked">
                                                        <span class="toggler"></span>
                                                    </label>
                                                </template>

                                                <!-- Range field -->
                                                <template x-if="field.type === 'range'">
                                                    <div class="field-control">
                                                        <input type="range" :min="field.min" :max="field.max"
                                                            :step="field.step" :value="field.value"
                                                            :disabled="field.readonly === true"
                                                            @input="field.value = $event.target.value"
                                                            :class="field.classes">
                                                        <span class="range-value" x-text="field.value"></span>
                                                    </div>
                                                </template>

                                                <!-- Button field -->
                                                <template x-if="field.type === 'button'">
                                                    <button class="btn btn-field" :class="field.classes"
                                                        :disabled="field.readonly === true"
                                                        @click="handleFieldButton(field)" x-text="field.value"></button>
                                                </template>

                                                <!-- Select field -->
                                                <template x-if="field.type === 'select'">
                                                    <select :class="field.classes" x-model="field.value"
                                                        :disabled="field.readonly === true">
                                                        <template x-for="option in field.options" :key="option.value">
                                                            <option :value="option.value" x-text="option.label"
                                                                :selected="option.value === field.value"></option>
                                                        </template>
                                                    </select>
                                                </template>

                                                <!-- HTML field -->
                                                <template x-if="field.type === 'html'">
                                                    <div :class="field.classes" x-html="field.value"></div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- Tunnel section content - only visible in External Services tab -->
                            <div id="section-tunnel" class="section" x-show="activeTab === 'external'">
                                <x-component path="settings/tunnel/tunnel-section.html" />
                            </div>
                        </div>

                        <!-- Task Scheduler Tab Content -->
                        <div id="scheduler-tab-content" x-show="activeTab === 'scheduler'" x-cloak>
                            <!-- Settings section structure for task scheduler -->
                            <nav>
                                <ul>
                                    <li>
                                        <a href="#section-task-scheduler">
                                            <img src="/public/task_scheduler.svg" alt="Task Scheduler">
                                            <span>Task Scheduler</span>
                                        </a>
                                    </li>
                                </ul>
                            </nav>

                            <div id="section-task-scheduler" class="section" x-data="schedulerSettings">
                                <div class="section-title">Task Scheduler</div>
                                <div class="section-description">Manage scheduled tasks and automated processes for
                                    Agent Zero.</div>

                                <!-- Create Task Form -->
                                <div class="scheduler-form" x-show="isCreating">
                                    <div class="scheduler-form-header">
                                        <div class="scheduler-form-title">Create New Task</div>
                                        <div class="scheduler-form-actions">
                                            <button class="btn btn-ok btn-field" @click="saveTask()">
                                                Save
                                            </button>
                                            <button class="btn btn-cancel" @click="cancelEdit()">
                                                Cancel
                                            </button>
                                        </div>
                                    </div>

                                    <div class="scheduler-form-grid">
                                        <!-- Task Name -->
                                        <div class="scheduler-form-field">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">Task Name</label>
                                                <div class="scheduler-form-help">A unique name to identify this task
                                                </div>
                                            </div>
                                            <input type="text" x-model="editingTask.name" placeholder="Enter task name">
                                        </div>

                                        <!-- Task Type Selection -->
                                        <div class="scheduler-form-field">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">Type</label>
                                                <div class="scheduler-form-help">Task execution method</div>
                                            </div>
                                            <select x-model="editingTask.type">
                                                <option value="scheduled">Scheduled (Cron)</option>
                                                <option value="adhoc">Ad-hoc (Manual)</option>
                                                <option value="planned">Planned (Specific Times)</option>
                                            </select>
                                        </div>

                                        <div class="scheduler-form-field">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">Project</label>
                                                <div class="scheduler-form-help" x-text="editingTask.dedicated_context ? 'Inherited from the active chat project.' : 'Mirrors the shared context project.'"></div>
                                            </div>
                                            <template x-if="isCreating">
                                                <div class="project-selector">
                                                    <!-- <span class="project-color-ball"
                                                          :style="editingTask.project?.color ? { backgroundColor: editingTask.project.color } : { border: '1px solid var(--color-border)' }"></span> -->
                                                    <select class="scheduler-project-select"
                                                            x-model="selectedProjectSlug"
                                                            @change="onProjectSelect($event.target.value)">
                                                        <option value="">No project</option>
                                                        <template x-for="proj in projectOptions" :key="proj.name">
                                                            <option :value="proj.name" x-text="proj.title"></option>
                                                        </template>
                                                    </select>
                                                </div>
                                            </template>
                                            <template x-if="!isCreating">
                                                <div class="project-display">
                                                    <span class="project-color-ball"
                                                          :style="editingTask.project?.color ? { backgroundColor: editingTask.project.color } : { border: '1px solid var(--color-border)' }"></span>
                                                    <span x-text="formatProjectLabel(editingTask.project)"></span>
                                                </div>
                                            </template>
                                        </div>

                                        <!-- Task State in Create Form - Add after Task Type -->
                                        <div class="scheduler-form-field" x-show="isCreating">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">State</label>
                                                <div class="scheduler-form-help">Select the initial state of the task
                                                </div>
                                            </div>
                                            <div>
                                                <div class="scheduler-state-selector">
                                                    <span class="scheduler-status-badge scheduler-status-idle"
                                                        :class="{'scheduler-status-selected': editingTask.state === 'idle'}"
                                                        @click="editingTask.state = 'idle'">idle</span>
                                                    <span class="scheduler-status-badge scheduler-status-running"
                                                        :class="{'scheduler-status-selected': editingTask.state === 'running'}"
                                                        @click="editingTask.state = 'running'">running</span>
                                                    <span class="scheduler-status-badge scheduler-status-disabled"
                                                        :class="{'scheduler-status-selected': editingTask.state === 'disabled'}"
                                                        @click="editingTask.state = 'disabled'">disabled</span>
                                                    <span class="scheduler-status-badge scheduler-status-error"
                                                        :class="{'scheduler-status-selected': editingTask.state === 'error'}"
                                                        @click="editingTask.state = 'error'">error</span>
                                                </div>
                                                <div class="scheduler-state-explanation">
                                                    <span x-show="editingTask.state === 'idle'"><strong>idle</strong>:
                                                        ready to run</span>
                                                    <span
                                                        x-show="editingTask.state === 'running'"><strong>running</strong>:
                                                        currently executing</span>
                                                    <span
                                                        x-show="editingTask.state === 'disabled'"><strong>disabled</strong>:
                                                        won't execute automatically</span>
                                                    <span x-show="editingTask.state === 'error'"><strong>error</strong>:
                                                        task encountered an error</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Schedule (only for scheduled tasks) -->
                                        <div class="scheduler-form-field full-width"
                                            x-show="editingTask.type === 'scheduled'">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">Schedule</label>
                                                <div class="scheduler-form-help">Cron schedule for automated execution
                                                    (minute hour day month weekday)</div>
                                            </div>
                                            <div class="scheduler-schedule-builder">
                                                <div class="scheduler-schedule-field">
                                                    <span class="scheduler-schedule-label">Minute</span>
                                                    <input type="text" x-model="editingTask.schedule.minute"
                                                        placeholder="*" maxlength="9">
                                                </div>
                                                <div class="scheduler-schedule-field">
                                                    <span class="scheduler-schedule-label">Hour</span>
                                                    <input type="text" x-model="editingTask.schedule.hour"
                                                        placeholder="*" maxlength="9">
                                                </div>
                                                <div class="scheduler-schedule-field">
                                                    <span class="scheduler-schedule-label">Day</span>
                                                    <input type="text" x-model="editingTask.schedule.day"
                                                        placeholder="*" maxlength="9">
                                                </div>
                                                <div class="scheduler-schedule-field">
                                                    <span class="scheduler-schedule-label">Month</span>
                                                    <input type="text" x-model="editingTask.schedule.month"
                                                        placeholder="*" maxlength="9">
                                                </div>
                                                <div class="scheduler-schedule-field">
                                                    <span class="scheduler-schedule-label">Weekday</span>
                                                    <input type="text" x-model="editingTask.schedule.weekday"
                                                        placeholder="*" maxlength="9">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Plan (for planned tasks) -->
                                        <div class="scheduler-form-field full-width"
                                            x-show="editingTask.type === 'planned'">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">Plan</label>
                                                <div class="scheduler-form-help">Specific execution times for this task
                                                </div>
                                            </div>
                                            <div class="scheduler-plan-builder">
                                                <div class="scheduler-plan-todo">
                                                    <span class="scheduler-plan-label">Upcoming Executions</span>
                                                    <div class="scheduler-todo-list">
                                                        <template
                                                            x-if="editingTask.plan && Array.isArray(editingTask.plan.todo) && editingTask.plan.todo.length > 0">
                                                            <template x-for="(time, index) in editingTask.plan.todo"
                                                                :key="index">
                                                                <div class="scheduler-todo-item">
                                                                    <span x-text="formatDate(time)"></span>
                                                                    <button
                                                                        @click.prevent="editingTask.plan.todo.splice(index, 1)"
                                                                        class="scheduler-todo-remove">
                                                                        <svg xmlns="http://www.w3.org/2000/svg"
                                                                            width="16" height="16" viewBox="0 0 24 24"
                                                                            fill="none" stroke="currentColor"
                                                                            stroke-width="2" stroke-linecap="round"
                                                                            stroke-linejoin="round">
                                                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                                                        </svg>
                                                                    </button>
                                                                </div>
                                                            </template>
                                                        </template>
                                                        <template
                                                            x-if="!editingTask.plan || !Array.isArray(editingTask.plan.todo) || editingTask.plan.todo.length === 0">
                                                            <div class="scheduler-empty-plan">
                                                                No scheduled execution times yet. Add one below.
                                                            </div>
                                                        </template>
                                                        <div class="scheduler-add-todo">
                                                            <!-- Create form planned task input -->
                                                            <input type="text" id="newPlannedTime-create"
                                                                x-ref="plannedTimeCreate"
                                                                class="scheduler-flatpickr-input"
                                                                placeholder="Select date and time">
                                                            <!-- Create Task Form Add Time Button -->
                                                            <button @click.prevent="
                                                                const input = $refs.plannedTimeCreate;
                                                                if (!input) {
                                                                    console.error('Input reference not found for plannedTimeCreate');
                                                                    return;
                                                                }

                                                                // Ensure plan structure exists
                                                                if (!editingTask.plan) {
                                                                    editingTask.plan = { todo: [], in_progress: null, done: [] };
                                                                }
                                                                if (!Array.isArray(editingTask.plan.todo)) {
                                                                    editingTask.plan.todo = [];
                                                                }

                                                                // Get date from Flatpickr if available
                                                                let selectedDate;
                                                                if (input._flatpickr && input._flatpickr.selectedDates.length > 0) {
                                                                    selectedDate = input._flatpickr.selectedDates[0];
                                                                } else if (input.value) {
                                                                    selectedDate = new Date(input.value);
                                                                }

                                                                if (!selectedDate || isNaN(selectedDate.getTime())) {
                                                                    alert('Please select a valid date and time');
                                                                    return;
                                                                }

                                                                // Convert to ISO string and add to plan
                                                                editingTask.plan.todo.push(selectedDate.toISOString());

                                                                // Sort by date (earliest first)
                                                                editingTask.plan.todo.sort();

                                                                // Clear the input
                                                                if (input._flatpickr) {
                                                                    input._flatpickr.clear();
                                                                } else {
                                                                    input.value = '';
                                                                }
                                                            " class="scheduler-add-todo-button">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="16"
                                                                    height="16" viewBox="0 0 24 24" fill="none"
                                                                    stroke="currentColor" stroke-width="2"
                                                                    stroke-linecap="round" stroke-linejoin="round"
                                                                    style="margin-right: 4px;">
                                                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                                                </svg>
                                                                Add Time
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Token (for ad-hoc tasks) -->
                                        <div class="scheduler-form-field full-width"
                                            x-show="editingTask.type === 'adhoc'">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">Token</label>
                                                <div class="scheduler-form-help">Token used to trigger this task
                                                    externally</div>
                                            </div>
                                            <div class="input-group">
                                                <input type="text" x-model="editingTask.token"
                                                    placeholder="Token for ad-hoc task">
                                                <button class="scheduler-task-action"
                                                    @click="editingTask.token = generateRandomToken()">
                                                    Generate
                                                </button>
                                            </div>
                                        </div>

                                        <!-- System Prompt -->
                                        <div class="scheduler-form-field full-width">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">System Prompt</label>
                                                <div class="scheduler-form-help">System-level instructions for the
                                                    assistant</div>
                                            </div>
                                            <textarea x-model="editingTask.system_prompt"
                                                placeholder="System instructions for the AI"></textarea>
                                        </div>

                                        <!-- User Prompt -->
                                        <div class="scheduler-form-field full-width">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">User Prompt</label>
                                                <div class="scheduler-form-help">The main task prompt that will be
                                                    executed</div>
                                            </div>
                                            <textarea x-model="editingTask.prompt"
                                                placeholder="User message for the AI"></textarea>
                                        </div>

                                        <!-- Attachments Field -->
                                        <div class="scheduler-form-field full-width">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">Attachments</label>
                                                <div class="scheduler-form-help">Container file paths or URLs, one per
                                                    line</div>
                                            </div>
                                            <textarea x-model="attachmentsText"
                                                placeholder="Enter file paths or URLs, one per line"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Edit Task Form -->
                                <div class="scheduler-form" x-show="isEditing">
                                    <div class="scheduler-form-header">
                                        <div class="scheduler-form-title">Edit Task</div>
                                        <div class="scheduler-form-actions">
                                            <button class="btn btn-ok btn-field" @click="saveTask()">
                                                Save
                                            </button>
                                            <button class="btn btn-cancel" @click="cancelEdit()">
                                                Cancel
                                            </button>
                                        </div>
                                    </div>

                                    <div class="scheduler-form-grid">
                                        <!-- Task Name -->
                                        <div class="scheduler-form-field">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">Task Name</label>
                                                <div class="scheduler-form-help">A unique name to identify this task
                                                </div>
                                            </div>
                                            <input type="text" x-model="editingTask.name" placeholder="Enter task name">
                                        </div>

                                        <!-- Task Type (disabled when editing) -->
                                        <div class="scheduler-form-field">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">Task Type</label>
                                                <div class="scheduler-form-help">Task type cannot be changed after
                                                    creation</div>
                                            </div>
                                            <select x-model="editingTask.type" disabled>
                                                <option value="scheduled">Scheduled Task</option>
                                                <option value="adhoc">Ad-hoc Task</option>
                                                <option value="planned">Planned Task</option>
                                            </select>
                                        </div>

                                        <div class="scheduler-form-field">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">Project</label>
                                                <div class="scheduler-form-help" x-text="editingTask.dedicated_context ? 'Dedicated tasks inherit the active chat project.' : 'Shared tasks mirror the project assigned to their context.'"></div>
                                            </div>
                                            <div class="project-display">
                                                <span class="project-color-ball" :style="editingTask.project?.color ? { backgroundColor: editingTask.project.color } : { border: '1px solid var(--color-border)' }"></span>
                                                <span x-text="formatProjectLabel(editingTask.project)"></span>
                                            </div>
                                        </div>

                                        <!-- Task State in Edit Form - Add after Task Type -->
                                        <div class="scheduler-form-field" x-show="isEditing">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">State</label>
                                                <div class="scheduler-form-help">Change the task's state</div>
                                            </div>
                                            <div>
                                                <div class="scheduler-state-selector">
                                                    <span class="scheduler-status-badge scheduler-status-idle"
                                                        :class="{'scheduler-status-selected': editingTask.state === 'idle'}"
                                                        @click="editingTask.state = 'idle'">idle</span>
                                                    <span class="scheduler-status-badge scheduler-status-running"
                                                        :class="{'scheduler-status-selected': editingTask.state === 'running'}"
                                                        @click="editingTask.state = 'running'">running</span>
                                                    <span class="scheduler-status-badge scheduler-status-disabled"
                                                        :class="{'scheduler-status-selected': editingTask.state === 'disabled'}"
                                                        @click="editingTask.state = 'disabled'">disabled</span>
                                                    <span class="scheduler-status-badge scheduler-status-error"
                                                        :class="{'scheduler-status-selected': editingTask.state === 'error'}"
                                                        @click="editingTask.state = 'error'">error</span>
                                                </div>
                                                <div class="scheduler-state-explanation">
                                                    <span x-show="editingTask.state === 'idle'"><strong>idle</strong>:
                                                        ready to run</span>
                                                    <span
                                                        x-show="editingTask.state === 'running'"><strong>running</strong>:
                                                        currently executing</span>
                                                    <span
                                                        x-show="editingTask.state === 'disabled'"><strong>disabled</strong>:
                                                        won't execute automatically</span>
                                                    <span x-show="editingTask.state === 'error'"><strong>error</strong>:
                                                        task encountered an error</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Schedule (for scheduled tasks) -->
                                        <div class="scheduler-form-field full-width"
                                            x-show="editingTask && editingTask.type === 'scheduled'">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">Schedule (Cron Expression)</label>
                                                <div class="scheduler-form-help">Format: minute hour day month weekday
                                                    (e.g., "* * * * *" for every minute)</div>
                                            </div>
                                            <div class="scheduler-schedule-builder">
                                                <div class="scheduler-schedule-field">
                                                    <span class="scheduler-schedule-label">Minute</span>
                                                    <input type="text" x-model="editingTask.schedule.minute"
                                                        placeholder="*" maxlength="9">
                                                </div>
                                                <div class="scheduler-schedule-field">
                                                    <span class="scheduler-schedule-label">Hour</span>
                                                    <input type="text" x-model="editingTask.schedule.hour"
                                                        placeholder="*" maxlength="9">
                                                </div>
                                                <div class="scheduler-schedule-field">
                                                    <span class="scheduler-schedule-label">Day</span>
                                                    <input type="text" x-model="editingTask.schedule.day"
                                                        placeholder="*" maxlength="9">
                                                </div>
                                                <div class="scheduler-schedule-field">
                                                    <span class="scheduler-schedule-label">Month</span>
                                                    <input type="text" x-model="editingTask.schedule.month"
                                                        placeholder="*" maxlength="9">
                                                </div>
                                                <div class="scheduler-schedule-field">
                                                    <span class="scheduler-schedule-label">Weekday</span>
                                                    <input type="text" x-model="editingTask.schedule.weekday"
                                                        placeholder="*" maxlength="9">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Plan (for planned tasks) -->
                                        <div class="scheduler-form-field full-width"
                                            x-show="editingTask.type === 'planned'">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">Plan</label>
                                                <div class="scheduler-form-help">Specific execution times for this task
                                                </div>
                                            </div>
                                            <div class="scheduler-plan-builder">
                                                <div class="scheduler-plan-todo">
                                                    <span class="scheduler-plan-label">Upcoming Executions</span>
                                                    <div class="scheduler-todo-list">
                                                        <template
                                                            x-if="editingTask.plan && Array.isArray(editingTask.plan.todo) && editingTask.plan.todo.length > 0">
                                                            <template x-for="(time, index) in editingTask.plan.todo"
                                                                :key="index">
                                                                <div class="scheduler-todo-item">
                                                                    <span x-text="formatDate(time)"></span>
                                                                    <button
                                                                        @click.prevent="editingTask.plan.todo.splice(index, 1)"
                                                                        class="scheduler-todo-remove">
                                                                        <svg xmlns="http://www.w3.org/2000/svg"
                                                                            width="16" height="16" viewBox="0 0 24 24"
                                                                            fill="none" stroke="currentColor"
                                                                            stroke-width="2" stroke-linecap="round"
                                                                            stroke-linejoin="round">
                                                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                                                        </svg>
                                                                    </button>
                                                                </div>
                                                            </template>
                                                        </template>
                                                        <template
                                                            x-if="!editingTask.plan || !Array.isArray(editingTask.plan.todo) || editingTask.plan.todo.length === 0">
                                                            <div class="scheduler-empty-plan">
                                                                No scheduled execution times yet. Add one below.
                                                            </div>
                                                        </template>
                                                        <div class="scheduler-add-todo">
                                                            <!-- Edit form planned task input -->
                                                            <input type="text" id="newPlannedTime-edit"
                                                                x-ref="plannedTimeEdit"
                                                                class="scheduler-flatpickr-input"
                                                                placeholder="Select date and time">
                                                            <!-- Edit Task Form Add Time Button -->
                                                            <button @click.prevent="
                                                                const input = $refs.plannedTimeEdit;
                                                                if (!input) {
                                                                    console.error('Input reference not found for plannedTimeEdit');
                                                                    return;
                                                                }

                                                                // Ensure plan structure exists
                                                                if (!editingTask.plan) {
                                                                    editingTask.plan = { todo: [], in_progress: null, done: [] };
                                                                }
                                                                if (!Array.isArray(editingTask.plan.todo)) {
                                                                    editingTask.plan.todo = [];
                                                                }

                                                                // Get date from Flatpickr if available
                                                                let selectedDate;
                                                                if (input._flatpickr && input._flatpickr.selectedDates.length > 0) {
                                                                    selectedDate = input._flatpickr.selectedDates[0];
                                                                } else if (input.value) {
                                                                    selectedDate = new Date(input.value);
                                                                }

                                                                if (!selectedDate || isNaN(selectedDate.getTime())) {
                                                                    alert('Please select a valid date and time');
                                                                    return;
                                                                }

                                                                // Convert to ISO string and add to plan
                                                                editingTask.plan.todo.push(selectedDate.toISOString());

                                                                // Sort by date (earliest first)
                                                                editingTask.plan.todo.sort();

                                                                // Clear the input
                                                                if (input._flatpickr) {
                                                                    input._flatpickr.clear();
                                                                } else {
                                                                    input.value = '';
                                                                }
                                                            " class="scheduler-add-todo-button">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="16"
                                                                    height="16" viewBox="0 0 24 24" fill="none"
                                                                    stroke="currentColor" stroke-width="2"
                                                                    stroke-linecap="round" stroke-linejoin="round"
                                                                    style="margin-right: 4px;">
                                                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                                                </svg>
                                                                Add Time
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Token (for ad-hoc tasks) -->
                                        <div class="scheduler-form-field full-width"
                                            x-show="editingTask.type === 'adhoc'">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">Token</label>
                                                <div class="scheduler-form-help">Token used to trigger this task
                                                    externally</div>
                                            </div>
                                            <div class="input-group">
                                                <input type="text" x-model="editingTask.token"
                                                    placeholder="Token for ad-hoc task">
                                                <button class="scheduler-task-action"
                                                    @click="editingTask.token = generateRandomToken()">
                                                    Generate
                                                </button>
                                            </div>
                                        </div>

                                        <!-- System Prompt -->
                                        <div class="scheduler-form-field full-width">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">System Prompt</label>
                                                <div class="scheduler-form-help">System-level instructions for the
                                                    assistant</div>
                                            </div>
                                            <textarea x-model="editingTask.system_prompt"
                                                placeholder="System instructions for the AI"></textarea>
                                        </div>

                                        <!-- User Prompt -->
                                        <div class="scheduler-form-field full-width">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">User Prompt</label>
                                                <div class="scheduler-form-help">The main task prompt that will be
                                                    executed</div>
                                            </div>
                                            <textarea x-model="editingTask.prompt"
                                                placeholder="User message for the AI"></textarea>
                                        </div>

                                        <!-- Attachments Field -->
                                        <div class="scheduler-form-field full-width">
                                            <div class="label-help-wrapper">
                                                <label class="scheduler-form-label">Attachments</label>
                                                <div class="scheduler-form-help">Container file paths or URLs, one per
                                                    line</div>
                                            </div>
                                            <textarea x-model="attachmentsText"
                                                placeholder="Enter file paths or URLs, one per line"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Task List View -->
                                <div class="scheduler-container"
                                    x-show="!isCreating && !isEditing && viewMode === 'list'">
                                    <!-- Header with Actions -->
                                    <div class="scheduler-header">
                                        <h2>Task Management</h2>
                                        <div class="scheduler-actions">
                                            <button class="btn btn-ok" @click="startCreateTask()">
                                                New Task
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Filters -->
                                    <div class="scheduler-filters">
                                        <div class="scheduler-filter-group">
                                            <span class="scheduler-filter-label">Type:</span>
                                            <select class="scheduler-filter-select" x-model="filterType">
                                                <option value="all">All Types</option>
                                                <option value="scheduled">Scheduled</option>
                                                <option value="adhoc">Ad-hoc</option>
                                                <option value="planned">Planned</option>
                                            </select>
                                        </div>

                                        <div class="scheduler-filter-group">
                                            <span class="scheduler-filter-label">State:</span>
                                            <select class="scheduler-filter-select" x-model="filterState">
                                                <option value="all">All States</option>
                                                <option value="idle">Idle</option>
                                                <option value="running">Running</option>
                                                <option value="disabled">Disabled</option>
                                                <option value="error">Error</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Loading State -->
                                    <!-- <div class="scheduler-loading" x-show="isLoading">
                                        Loading tasks...
                                    </div> -->

                                    <!-- Empty State -->
                                    <div class="scheduler-empty" x-show="!isLoading && filteredTasks.length === 0"
                                        x-effect="$el.style.display = (!isLoading && filteredTasks.length === 0) ? '' : 'none'">
                                        <!-- <div class="scheduler-empty-icon"></div> -->
                                        <div class="scheduler-empty-text">No tasks found</div>
                                        <button class="btn btn-ok" @click="startCreateTask()">Create your first
                                            task</button>
                                    </div>

                                    <!-- Task List Table -->
                                    <table class="scheduler-task-list" x-show="!isLoading && filteredTasks.length > 0"
                                        x-effect="$el.style.display = (!isLoading && filteredTasks.length > 0) ? '' : 'none'">
                                        <thead>
                                            <tr>
                                                <th @click="changeSort('name')">
                                                    Name
                                                    <span class="scheduler-sort-indicator" x-show="sortField === 'name'"
                                                        :class="{'scheduler-sort-desc': sortDirection === 'desc'}"></span>
                                                </th>
                                                <th @click="changeSort('state')">
                                                    State
                                                    <span class="scheduler-sort-indicator"
                                                        x-show="sortField === 'state'"
                                                        :class="{'scheduler-sort-desc': sortDirection === 'desc'}"></span>
                                                </th>
                                                <th>Type</th>
                                                <th>Project</th>
                                                <th>Schedule</th>
                                                <th @click="changeSort('last_run')">
                                                    Last Run
                                                    <span class="scheduler-sort-indicator"
                                                        x-show="sortField === 'last_run'"
                                                        :class="{'scheduler-sort-desc': sortDirection === 'desc'}"></span>
                                                </th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="task in filteredTasks" :key="task.uuid">
                                                <tr @click="showTaskDetail(task.uuid)">
                                                    <td>
                                                        <span x-text="task.name"></span>
                                                    </td>
                                                    <td>
                                                        <span class="scheduler-status-badge"
                                                            :class="getStateBadgeClass(task.state)"
                                                            x-text="task.state"></span>
                                                    </td>
                                                    <td x-text="task.type"></td>
                                                    <td>
                                                        <span class="project-color-ball"
                                                              :style="extractTaskProject(task)?.color ? { backgroundColor: extractTaskProject(task).color } : { border: '1px solid var(--color-border)' }"></span>
                                                        <span x-text="formatTaskProject(task)"></span>
                                                    </td>
                                                    <td>
                                                        <span x-show="task.type === 'scheduled'"
                                                            x-text="formatSchedule(task)"></span>
                                                        <span x-show="task.type === 'adhoc'"
                                                            class="scheduler-no-schedule"></span>
                                                        <span x-show="task.type === 'planned'"
                                                            x-html="formatPlan(task).replace(/\n/g, '<br>')"></span>
                                                    </td>
                                                    <td x-text="formatDate(task.last_run)"></td>
                                                    <td @click.stop>
                                                        <div class="scheduler-task-actions">
                                                            <button class="scheduler-task-action"
                                                                @click="runTask(task.uuid)" title="Run Task">
                                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                                    viewBox="0 0 24 24" fill="currentColor" width="16"
                                                                    height="16">
                                                                    <path d="M8 5v14l11-7z" />
                                                                </svg>
                                                            </button>
                                                            <button class="scheduler-task-action"
                                                                @click="resetTaskState(task.uuid)" title="Reset State">
                                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                                    viewBox="0 0 24 24" fill="currentColor" width="16"
                                                                    height="16">
                                                                    <path
                                                                        d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                                                                </svg>
                                                            </button>
                                                            <button class="scheduler-task-action"
                                                                @click="startEditTask(task.uuid)" title="Edit Task">
                                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                                    viewBox="0 0 24 24" fill="currentColor" width="16"
                                                                    height="16">
                                                                    <path
                                                                        d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
                                                                </svg>
                                                            </button>
                                                            <button class="scheduler-task-action"
                                                                @click="deleteTask(task.uuid)" title="Delete Task">
                                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                                    viewBox="0 0 24 24" fill="currentColor" width="16"
                                                                    height="16">
                                                                    <path
                                                                        d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Task Detail View -->
                                <div class="scheduler-detail-view"
                                    x-show="!isCreating && !isEditing && viewMode === 'detail' && selectedTaskForDetail">
                                    <div class="scheduler-detail-header">
                                        <h2 class="scheduler-detail-title"
                                            x-text="selectedTaskForDetail ? selectedTaskForDetail.name : ''"></h2>
                                        <div class="scheduler-status-badge"
                                            :class="selectedTaskForDetail ? getStateBadgeClass(selectedTaskForDetail.state) : ''"
                                            x-text="selectedTaskForDetail ? selectedTaskForDetail.state : ''">
                                        </div>
                                        <button class="btn btn-cancel" @click="closeTaskDetail()">Close</button>
                                    </div>

                                    <div class="scheduler-detail-content">
                                        <div class="scheduler-details-grid">
                                            <div class="scheduler-details-label">Type:</div>
                                            <div class="scheduler-details-value"
                                                x-text="selectedTaskForDetail ? selectedTaskForDetail.type : ''"></div>

                                            <div class="scheduler-details-label">Project:</div>
                                            <div class="scheduler-details-value">
                                                <span class="project-color-ball"
                                                      :style="extractTaskProject(selectedTaskForDetail)?.color ? { backgroundColor: extractTaskProject(selectedTaskForDetail).color } : { border: '1px solid var(--color-border)' }"></span>
                                                <span x-text="selectedTaskForDetail ? formatTaskProject(selectedTaskForDetail) : 'No Project'"></span>
                                            </div>

                                            <div class="scheduler-details-label">Created:</div>
                                            <div class="scheduler-details-value"
                                                x-text="selectedTaskForDetail ? formatDate(selectedTaskForDetail.created_at) : ''">
                                            </div>

                                            <div class="scheduler-details-label">Last Updated:</div>
                                            <div class="scheduler-details-value"
                                                x-text="selectedTaskForDetail ? formatDate(selectedTaskForDetail.updated_at) : ''">
                                            </div>

                                            <div class="scheduler-details-label">Last Run:</div>
                                            <div class="scheduler-details-value"
                                                x-text="selectedTaskForDetail ? formatDate(selectedTaskForDetail.last_run) : ''">
                                            </div>

                                            <div class="scheduler-details-label"
                                                x-show="selectedTaskForDetail && selectedTaskForDetail.type === 'scheduled'">
                                                Schedule:</div>
                                            <div class="scheduler-details-value"
                                                x-show="selectedTaskForDetail && selectedTaskForDetail.type === 'scheduled'"
                                                x-text="selectedTaskForDetail ? formatSchedule(selectedTaskForDetail) : ''">
                                            </div>

                                            <div class="scheduler-details-label"
                                                x-show="selectedTaskForDetail && selectedTaskForDetail.type === 'adhoc'">
                                                Token:</div>
                                            <div class="scheduler-details-value"
                                                x-show="selectedTaskForDetail && selectedTaskForDetail.type === 'adhoc'"
                                                x-text="selectedTaskForDetail ? selectedTaskForDetail.token : ''"></div>

                                            <div class="scheduler-details-label"
                                                x-show="selectedTaskForDetail && selectedTaskForDetail.type === 'planned'">
                                                Plan:</div>
                                            <div class="scheduler-details-value"
                                                x-show="selectedTaskForDetail && selectedTaskForDetail.type === 'planned'">
                                                <div x-show="selectedTaskForDetail && selectedTaskForDetail.plan">
                                                    <div><strong>Upcoming:</strong></div>
                                                    <template
                                                        x-if="selectedTaskForDetail && selectedTaskForDetail.plan && selectedTaskForDetail.plan.todo && selectedTaskForDetail.plan.todo.length > 0">
                                                        <div>
                                                            <template
                                                                x-for="(time, index) in selectedTaskForDetail.plan.todo"
                                                                :key="index">
                                                                <div x-text="formatDate(time)"></div>
                                                            </template>
                                                        </div>
                                                    </template>
                                                    <template
                                                        x-if="!selectedTaskForDetail || !selectedTaskForDetail.plan || !selectedTaskForDetail.plan.todo || selectedTaskForDetail.plan.todo.length === 0">
                                                        <div>No upcoming executions</div>
                                                    </template>

                                                    <div><strong>In Progress:</strong></div>
                                                    <div
                                                        x-text="selectedTaskForDetail && selectedTaskForDetail.plan && selectedTaskForDetail.plan.in_progress ? formatDate(selectedTaskForDetail.plan.in_progress) : 'None'">
                                                    </div>

                                                    <div><strong>Completed:</strong></div>
                                                    <template
                                                        x-if="selectedTaskForDetail && selectedTaskForDetail.plan && selectedTaskForDetail.plan.done && selectedTaskForDetail.plan.done.length > 0">
                                                        <div>
                                                            <template
                                                                x-for="(time, index) in selectedTaskForDetail.plan.done"
                                                                :key="index">
                                                                <div x-text="formatDate(time)"></div>
                                                            </template>
                                                        </div>
                                                    </template>
                                                    <template
                                                        x-if="!selectedTaskForDetail || !selectedTaskForDetail.plan || !selectedTaskForDetail.plan.done || selectedTaskForDetail.plan.done.length === 0">
                                                        <div>No completed executions</div>
                                                    </template>
                                                </div>
                                            </div>

                                            <div class="scheduler-details-label">Last Result:</div>
                                            <div class="scheduler-details-value"
                                                x-text="selectedTaskForDetail && selectedTaskForDetail.last_result ? selectedTaskForDetail.last_result : 'No results yet'">
                                            </div>

                                            <div class="scheduler-details-label">System Prompt:</div>
                                            <div class="scheduler-details-value"
                                                x-text="selectedTaskForDetail ? selectedTaskForDetail.system_prompt : ''">
                                            </div>

                                            <div class="scheduler-details-label">User Prompt:</div>
                                            <div class="scheduler-details-value"
                                                x-text="selectedTaskForDetail ? selectedTaskForDetail.prompt : ''">
                                            </div>

                                            <div class="scheduler-details-label">Attachments:</div>
                                            <div class="scheduler-details-value">
                                                <template
                                                    x-if="selectedTaskForDetail && selectedTaskForDetail.attachments && selectedTaskForDetail.attachments.length > 0">
                                                    <div>
                                                        <template
                                                            x-for="(attachment, index) in selectedTaskForDetail.attachments"
                                                            :key="index">
                                                            <div x-text="attachment"></div>
                                                        </template>
                                                    </div>
                                                </template>
                                                <template
                                                    x-if="!selectedTaskForDetail || !selectedTaskForDetail.attachments || selectedTaskForDetail.attachments.length === 0">
                                                    <div>No attachments</div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Heisenberg Tab Content -->
                        <div id="heisenberg-tab-content" x-show="activeTab === 'heisenberg'" x-cloak>
                            <nav>
                                <ul>
                                    <li>
                                        <a href="#section-heisenberg-dashboard">
                                            <img src="/public/heisenberg.svg" alt="Dashboard" onerror="this.src='/public/network.svg'">
                                            <span>Dashboard</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#section-heisenberg-monitor">
                                            <img src="/public/monitor.svg" alt="Monitor" onerror="this.src='/public/network.svg'">
                                            <span>Monitor</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#section-heisenberg-queue">
                                            <img src="/public/task_scheduler.svg" alt="Task Queue">
                                            <span>Task Queue</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#section-heisenberg-instruments">
                                            <img src="/public/tools.svg" alt="Instruments">
                                            <span>Instruments</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#section-heisenberg-config">
                                            <img src="/public/settings.svg" alt="Configuration">
                                            <span>Configuration</span>
                                        </a>
                                    </li>
                                </ul>
                            </nav>

                            <!-- Heisenberg Dashboard Section -->
                            <div id="section-heisenberg-dashboard" class="section">
                                <x-component path="settings/heisenberg/heisenberg-dashboard.html"></x-component>
                            </div>

                            <!-- Heisenberg Real-Time Monitor Section -->
                            <div id="section-heisenberg-monitor" class="section">
                                <div class="section-title">Real-Time Monitor</div>
                                <div class="section-description">Live monitoring of Heisenberg system activity and events.</div>
                                <x-component path="settings/heisenberg/realtime-monitor.html"></x-component>
                            </div>

                            <!-- Heisenberg Task Queue Section -->
                            <div id="section-heisenberg-queue" class="section">
                                <div class="section-title">Task Queue</div>
                                <div class="section-description">Monitor Heisenberg system activity and task execution metrics.</div>
                                <x-component path="settings/heisenberg/task-queue.html"></x-component>
                            </div>

                            <!-- Heisenberg Instruments Section -->
                            <div id="section-heisenberg-instruments" class="section">
                                <x-component path="settings/heisenberg/instruments-panel.html"></x-component>
                            </div>

                            <!-- Heisenberg Configuration Section -->
                            <div id="section-heisenberg-config" class="section">
                                <x-component path="settings/heisenberg/heisenberg-settings.html"></x-component>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <div id="buttons-container">
                            <template x-for="button in settings.buttons" :key="button.id">
                                <button :class="button.classes" @click="handleButton(button.id)"
                                    x-text="button.title"></button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Drag and Drop Overlay Component -->
    <x-component path="chat/attachments/dragDropOverlay.html"></x-component>

    <!-- BAEL - Lord Of All Enhanced Systems -->
    <script src="js/bael-command-palette.js"></script>
    <script src="js/bael-focus-mode.js"></script>
    <script src="js/bael-token-counter.js"></script>
    <script src="js/bael-notes-panel.js"></script>
    <script src="js/bael-thinking-viz.js"></script>
    <script src="js/bael-prompt-library.js"></script>
    <script src="js/bael-performance.js"></script>
    <script src="js/bael-theme-editor.js"></script>
    <script src="js/bael-split-view.js"></script>
    <script src="js/bael-floating-action.js"></script>
    <script src="js/bael-chat-search.js"></script>
    <script src="js/bael-keybindings.js"></script>
    <script src="js/bael-export.js"></script>
    <script src="js/bael-context-menu.js"></script>
    <script src="js/bael-session-stats.js"></script>
    <script src="js/bael-markdown-preview.js"></script>
    <script src="js/bael-notifications.js"></script>
    <script src="js/bael-audio.js"></script>
    <script src="js/bael-macro-recorder.js"></script>
    <script src="js/bael-voice-commands.js"></script>
    <script src="js/bael-memory-viz.js"></script>
    <script src="js/bael-workflow-builder.js"></script>
    <script src="js/bael-plugin-system.js"></script>
    <script src="js/bael-multimodel.js"></script>
    <script src="js/bael-timeline.js"></script>
    <script src="js/bael-playground.js"></script>
    <script src="js/bael-dashboard.js"></script>
    <script src="js/bael-personas.js"></script>
    <script src="js/bael-bookmarks.js"></script>
    <script src="js/bael-templates.js"></script>
    <script src="js/bael-accessibility.js"></script>
    <script src="js/bael-diff-viewer.js"></script>
    <script src="js/bael-terminal.js"></script>
    <script src="js/bael-analytics.js"></script>
    <script src="js/bael-snippets.js"></script>
    <script src="js/bael-filetree.js"></script>
    <script src="js/bael-quick-actions.js"></script>
    <script src="js/bael-collaboration.js"></script>
    <script src="js/bael-history.js"></script>
    <script src="js/bael-auto-save.js"></script>
    <script src="js/bael-branching.js"></script>
    <script src="js/bael-rating.js"></script>
    <script src="js/bael-shortcuts.js"></script>
    <script src="js/bael-connection.js"></script>
    <script src="js/bael-model-compare.js"></script>
    <script src="js/bael-context-viz.js"></script>
    <script src="js/bael-agent-monitor.js"></script>
    <script src="js/bael-conversation-flow.js"></script>
    <script src="js/bael-smart-suggestions.js"></script>
    <script src="js/bael-session-manager.js"></script>
    <script src="js/bael-message-pinning.js"></script>
    <script src="js/bael-notification-center.js"></script>
    <script src="js/bael-quick-reply.js"></script>
    <script src="js/bael-response-cache.js"></script>

    <!-- BAEL Phase 3 - Advanced Power Systems -->
    <script src="js/bael-markdown-renderer.js"></script>
    <script src="js/bael-sentiment-analyzer.js"></script>
    <script src="js/bael-agent-roster.js"></script>
    <script src="js/bael-image-generator.js"></script>
    <script src="js/bael-task-scheduler.js"></script>
    <script src="js/bael-conversation-branches.js"></script>
    <script src="js/bael-api-monitor.js"></script>
    <script src="js/bael-memory-browser.js"></script>
    <script src="js/bael-code-refactor.js"></script>
    <script src="js/bael-debug-console.js"></script>
    <script src="js/bael-model-selector.js"></script>
    <script src="js/bael-secret-vault.js"></script>
    <script src="js/bael-network-inspector.js"></script>

    <!-- BAEL Phase 4 - Missing Systems Integration -->
    <script src="js/bael-code-playground.js"></script>
    <script src="js/bael-context-monitor.js"></script>
    <script src="js/bael-message-bookmarks.js"></script>
    <script src="js/bael-message-reactions.js"></script>
    <script src="js/bael-persona-switcher.js"></script>
    <script src="js/bael-timeline-visualizer.js"></script>
    <script src="js/bael-typing-indicator.js"></script>
    <script src="js/bael-workspace-manager.js"></script>

    <!-- HEISENBERG Cognitive System -->
    <script type="module" src="js/heisenberg-shortcuts.js"></script>

    <!-- BAEL Phase 5 - Advanced Infrastructure -->
    <script src="js/bael-multi-model-router.js"></script>
    <script src="js/bael-cost-tracker.js"></script>
    <script src="js/bael-scheduler.js"></script>
    <script src="js/bael-offline-controller.js"></script>
    <script src="js/bael-analytics-dashboard.js"></script>
    <script src="js/bael-mobile-layout.js"></script>

    <!-- BAEL Phase 6 - Extensibility & Security -->
    <script src="js/bael-workflow-engine.js"></script>
    <script src="js/bael-plugin-manager.js"></script>
    <script src="js/bael-apikey-manager.js"></script>
    <script src="js/bael-backup-system.js"></script>
    <script src="js/bael-knowledge-graph.js"></script>
    <script src="js/bael-collaboration-mode.js"></script>
    <script src="js/bael-code-editor.js"></script>
    <script src="js/bael-fine-tuning.js"></script>
    <script src="js/bael-realtime-sync.js"></script>
    <script src="js/bael-context-manager.js"></script>
    <script src="js/bael-persona-system.js"></script>
    <script src="js/bael-session-recorder.js"></script>
    <script src="js/bael-response-formatter.js"></script>
    <script src="js/bael-chat-analytics.js"></script>
    <script src="js/bael-smart-suggestions.js"></script>
    <script src="js/bael-prompt-library.js"></script>

    <!-- BAEL Phase 7: Testing, Documentation & Performance -->
    <script src="js/bael-test-suite.js"></script>
    <script src="js/bael-performance-monitor.js"></script>
    <script src="js/bael-documentation.js"></script>
    <script src="js/bael-error-boundary.js"></script>
    <script src="js/bael-lazy-loader.js"></script>
    <script src="js/bael-state-machine.js"></script>
    <script src="js/bael-event-bus.js"></script>
    <script src="js/bael-feature-flags.js"></script>
    <script src="js/bael-telemetry.js"></script>
    <script src="js/bael-di-container.js"></script>
    <script src="js/bael-middleware.js"></script>
    <script src="js/bael-config-manager.js"></script>
    <script src="js/bael-router.js"></script>
    <script src="js/bael-cache-manager.js"></script>
    <script src="js/bael-api-client.js"></script>
    <script src="js/bael-form-validator.js"></script>
    <script src="js/bael-logger.js"></script>
    <script src="js/bael-keyboard-manager.js"></script>
    <script src="js/bael-toast.js"></script>
    <script src="js/bael-modal.js"></script>
    <script src="js/bael-clipboard.js"></script>
    <script src="js/bael-storage.js"></script>
    <script src="js/bael-network-monitor.js"></script>
    <script src="js/bael-drag-drop.js"></script>
    <script src="js/bael-animate.js"></script>
    <script src="js/bael-timer.js"></script>
    <script src="js/bael-dom.js"></script>
    <script src="js/bael-color.js"></script>
    <script src="js/bael-string.js"></script>
    <script src="js/bael-datetime.js"></script>
    <script src="js/bael-hub.js"></script>
    <script src="js/bael-object.js"></script>
    <script src="js/bael-math.js"></script>
    <script src="js/bael-validate.js"></script>
    <script src="js/bael-crypto.js"></script>
    <script src="js/bael-http.js"></script>
    <script src="js/bael-test.js"></script>
    <script src="js/bael-a11y.js"></script>
    <script src="js/bael-media.js"></script>
    <script src="js/bael-socket.js"></script>
    <script src="js/bael-geo.js"></script>
    <script src="js/bael-query.js"></script>
    <script src="js/bael-schema.js"></script>
    <script src="js/bael-i18n.js"></script>
    <script src="js/bael-worker.js"></script>
    <script src="js/bael-perf.js"></script>
    <script src="js/bael-debug.js"></script>
    <script src="js/bael-docs.js"></script>
    <script src="js/bael-bundle.js"></script>
    <script src="js/bael-sdk.js"></script>
    <script src="js/bael-plugins.js"></script>
    <script src="js/bael-stream.js"></script>
    <script src="js/bael-queue.js"></script>
    <script src="js/bael-pool.js"></script>
    <script src="js/bael-fsm.js"></script>
    <script src="js/bael-template.js"></script>
    <script src="js/bael-command.js"></script>
    <script src="js/bael-proxy.js"></script>
    <script src="js/bael-signal.js"></script>
    <script src="js/bael-request.js"></script>
    <script src="js/bael-virtual-list.js"></script>
    <script src="js/bael-transition.js"></script>
    <script src="js/bael-focus.js"></script>

    <!-- BAEL Phase 7 Part 7 - Observer Systems -->
    <script src="js/bael-intersection.js"></script>
    <script src="js/bael-resize.js"></script>
    <script src="js/bael-mutation.js"></script>

    <!-- BAEL Phase 7 Part 7 - Interaction Systems -->
    <script src="js/bael-drag.js"></script>
    <script src="js/bael-gesture.js"></script>
    <script src="js/bael-scroll.js"></script>

    <!-- BAEL Phase 7 Part 7 - UI Systems -->
    <script src="js/bael-portal.js"></script>
    <script src="js/bael-fullscreen.js"></script>
    <script src="js/bael-network.js"></script>

    <!-- BAEL Phase 7 Part 8 - Advanced Utilities -->
    <script src="js/bael-undo.js"></script>
    <script src="js/bael-reactive.js"></script>

    <!-- BAEL Phase 7 Part 8 - Component Library -->
    <script src="js/bael-accordion.js"></script>
    <script src="js/bael-tabs.js"></script>
    <script src="js/bael-dropdown.js"></script>
    <script src="js/bael-tooltip.js"></script>
    <script src="js/bael-carousel.js"></script>
    <script src="js/bael-dialog.js"></script>
    <script src="js/bael-popover.js"></script>
    <script src="js/bael-progress.js"></script>
    <script src="js/bael-slider.js"></script>
    <script src="js/bael-stepper.js"></script>
    <script src="js/bael-badge.js"></script>
    <script src="js/bael-avatar.js"></script>
    <script src="js/bael-card.js"></script>
    <script src="js/bael-table.js"></script>
    <script src="js/bael-form.js"></script>
    <script src="js/bael-tree.js"></script>
    <script src="js/bael-calendar.js"></script>
    <script src="js/bael-select.js"></script>
    <script src="js/bael-input.js"></script>
    <script src="js/bael-skeleton.js"></script>
    <script src="js/bael-infinite-scroll.js"></script>
    <script src="js/bael-copy.js"></script>

    <!-- BAEL Phase 7 Part 8 - Advanced Components -->
    <script src="js/bael-sortable.js"></script>
    <script src="js/bael-colorpicker.js"></script>
    <script src="js/bael-fileupload.js"></script>
    <script src="js/bael-kanban.js"></script>
    <script src="js/bael-richtext.js"></script>
    <script src="js/bael-splitpane.js"></script>
    <script src="js/bael-timepicker.js"></script>
    <script src="js/bael-datepicker.js"></script>
    <script src="js/bael-commandpalette.js"></script>
    <script src="js/bael-virtualscroll.js"></script>
    <script src="js/bael-chart.js"></script>
    <script src="js/bael-notificationcenter.js"></script>
    <script src="js/bael-breadcrumb.js"></script>

    <!-- BAEL Phase 7 Part 8 - Extended Components -->
    <script src="js/bael-pagination.js"></script>
    <script src="js/bael-taginput.js"></script>
    <script src="js/bael-imagecropper.js"></script>
    <script src="js/bael-emojipicker.js"></script>
    <script src="js/bael-mention.js"></script>
    <script src="js/bael-password.js"></script>
    <script src="js/bael-otp.js"></script>
    <script src="js/bael-marquee.js"></script>
    <script src="js/bael-syntaxhighlight.js"></script>
    <script src="js/bael-countdown.js"></script>
    <script src="js/bael-infinitescroll.js"></script>
    <script src="js/bael-lightbox.js"></script>
    <script src="js/bael-audioplayer.js"></script>
    <script src="js/bael-videoplayer.js"></script>

    <!-- BAEL Phase 7 Part 8 - Form Controls -->
    <script src="js/bael-rangeslider.js"></script>
    <script src="js/bael-ratinginput.js"></script>
    <script src="js/bael-toggleswitch.js"></script>
    <script src="js/bael-chip.js"></script>
    <script src="js/bael-alertbanner.js"></script>
    <script src="js/bael-numberinput.js"></script>
    <script src="js/bael-segmented.js"></script>
    <script src="js/bael-radiogroup.js"></script>
    <script src="js/bael-checkboxgroup.js"></script>
    <script src="js/bael-progresssteps.js"></script>
    <script src="js/bael-searchinput.js"></script>
    <script src="js/bael-badgecounter.js"></script>

    <!-- BAEL Phase 7 Part 8 - Display & Utility Components -->
    <script src="js/bael-statcard.js"></script>
    <script src="js/bael-emptystate.js"></script>
    <script src="js/bael-fab.js"></script>
    <script src="js/bael-errorboundary.js"></script>
    <script src="js/bael-divider.js"></script>
    <script src="js/bael-codeblock.js"></script>
    <script src="js/bael-list.js"></script>

    <!-- BAEL Power Systems - Ultimate Integration -->
    <script src="js/bael-supremacy.js"></script>
    <script src="js/bael-domination.js"></script>
    <script src="js/bael-omniscient.js"></script>
    <script src="js/bael-exploit.js"></script>
    <script src="js/bael-settings-bridge.js"></script>

    <!-- BAEL GUI Unification Layer - Complete Integration -->
    <script src="js/bael-gui-unifier.js"></script>
    <script src="js/bael-alpine-bridge.js"></script>

    <!-- BAEL Dashboards & Management Interfaces -->
    <script src="js/bael-memory-dashboard.js"></script>
    <script src="js/bael-agent-console.js"></script>
    <script src="js/bael-heisenberg-control.js"></script>
    <script src="js/bael-performance-dashboard.js"></script>
    <script src="js/bael-command-center.js"></script>
    <script src="js/bael-template-library.js"></script>

    <!-- BAEL Enhanced Integration Modules -->
    <script src="js/bael-unified-search.js"></script>
    <script src="js/bael-hotkey-reference.js"></script>
    <script src="js/bael-system-status.js"></script>
    <script src="js/bael-favorites-hub.js"></script>
    <script src="js/bael-ai-insights.js"></script>
    <script src="js/bael-quick-launcher.js"></script>

    <!-- BAEL Master Controller - Orchestrates All Systems -->
    <script src="js/bael-master-controller.js"></script>

    <!-- Register Service Worker for offline support and caching -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('js/bael-service-worker.js').then(registration => {
                    console.log('Bael SW registered: ', registration);
                }).catch(registrationError => {
                    console.log('Bael SW registration failed: ', registrationError);
                });
            });
        }

        // Initialize Bael theme from localStorage
        (function() {
            const savedTheme = localStorage.getItem('bael_theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            }
        })();
    </script>

</body>

</html>
